

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ism3d.uvhelper.ms &mdash; ism3d 0.3.dev1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/my_theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> ism3d
          

          
          </a>

          
            
            
              <div class="version">
                0.3.dev1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../history.html">History</a></li>
</ul>
<p class="caption"><span class="caption-text">Technical Specification/Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/inpfile.html">Parameter File Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/casa6.html">CASA6 Installation</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../develop/background.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develop/goals.html">Design Goals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develop/ack.html">Acknowledgement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develop/seealso.html">See also</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develop/reference.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develop/dictionary.html">ISM3D Dictionary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develop/callgraph.html">ISM3D call graph</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials: Direct API Usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/demo_api_uvhelper.html">ism3d.uvhelper: visibility imaging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/demo_api_arts.html">ism3d.arts: model artificial sources in different shapes</a></li>
</ul>
<p class="caption"><span class="caption-text">Benchmarking</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../benchmark/demo_invert_ft.html">Invert</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tests/test_uvsample_performance.html">Test the performance of the Image-to-MS-related modules</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials: Modeling</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../demos/demo_bx610_b4c2_uv_ab.html">Example BX610: perform model fitting using method=‘amoeba’ for the Band 4 Cycle 2 DataSet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../demos/demo_bx610_b4c5_uv_ab.html">Example BX610: perform model fitting using method=‘amoeba’ for the Band 4 Cycle 5 DataSet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../demos/demo_bx610_b6c3_uv_ab.html">Example BX610: perform model fitting using method=‘amoeba’ for the Band 6 Cycle 3 DataSet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../demos/demo_bx610_model_1dspec.html">Invert Visibility + Plot 1D spectra (may take a while)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../demos/demo_bx610_emcee.html">Example BX610: perform model fitting using method=‘emcee’</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../demos/demo_hxmm01_simulate.html">Example HXMM01: test the MS-simulation modules</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials: misc</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/demo_notebook.html">Tutorials &amp; Examples</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials: Data Preparation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../demos/demo_gn20_prep.html">Example: GN20 (z~4 SMF) : Data Prep</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../demos/demo_bx610_prep.html">Example: BX610 (High-z SFG) : Data Prep</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../demos/demo_hxmm01_prep.html">Example: HXMM01 (High-z Merger)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../demos/demo_gn20_imaging.html">Example GN20: perform imaging of CO 2-1 dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../demos/demo_bx610_imaging.html">Example: BX610 (High-z SFG) : Data Imaging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/demo_notebook.html">Tutorials &amp; Examples</a></li>
</ul>
<p class="caption"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/ism3d.html">ism3d</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ism3d</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>ism3d.uvhelper.ms</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ism3d.uvhelper.ms</h1><div class="highlight"><pre>
<span></span><span class="c1">#from .discretize import sample_prep, uv_sample, pickplane</span>
<span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">simulator</span>
<span class="c1">#from .model import makepb, get_image_size</span>
<span class="kn">from</span> <span class="nn">astropy.wcs.utils</span> <span class="kn">import</span> <span class="n">proj_plane_pixel_area</span><span class="p">,</span> <span class="n">proj_plane_pixel_scales</span>
<span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">importfits</span>
<span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">calibrater</span>
<span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">msmetadata</span>
<span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">table</span>
<span class="kn">import</span> <span class="nn">casatools</span> <span class="k">as</span> <span class="nn">ctools</span>
<span class="kn">import</span> <span class="nn">numexpr</span> <span class="k">as</span> <span class="nn">ne</span>

<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">WCS</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="kn">from</span> <span class="nn">..utils.misc</span> <span class="kn">import</span> <span class="n">human_unit</span><span class="p">,</span> <span class="n">human_to_string</span><span class="p">,</span> <span class="n">get_obj_size</span>
<span class="kn">from</span> <span class="nn">..utils.utils</span> <span class="kn">import</span> <span class="n">paste_array</span>

<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">Angle</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>

<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ref: about taql:</span>
<span class="sd">    https://casacore.github.io/casacore-notes/199.html</span>
<span class="sd">ref:</span>
<span class="sd">     C-contiguous order (last index varies the fastest</span>
<span class="sd">     FORTRAN-contiguous order in memory (first index varies the fastest)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># for instance constructed from classes, we use shorter names: tb, msmd, cb, etc...</span>
<span class="c1"># see at the end:</span>
<span class="c1">#    https://casa.nrao.edu/casadocs/casa-5.6.0/introduction/casa6-installation-and-usage</span>


<div class="viewcode-block" id="read_ms"><a class="viewcode-back" href="../../../_autosummary/ism3d.uvhelper.ms.read_ms.html#ism3d.uvhelper.ms.read_ms">[docs]</a><span class="k">def</span> <span class="nf">read_ms</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">polaverage</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">flagdata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">saveflag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">includedata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">usedouble</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">keyrule</span><span class="o">=</span><span class="s1">&#39;basename&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Note:</span>
<span class="sd">        the different output sequence</span>
<span class="sd">        casacore.table.getcol():     nrecord x nchan x ncorr</span>
<span class="sd">        casatools.table.getcol():    ncorr x nchan x nrecord</span>

<span class="sd">    flagdata: default=False</span>
<span class="sd">        set flagged data value to np.nan, which may lead to troubles of calculating chisq2</span>
<span class="sd">    saveflag: default=True</span>
<span class="sd">        save flagging (bool) column, which is need to figure out channel-wise bad data</span>

<span class="sd">    uvw in units of meters</span>
<span class="sd">    </span>
<span class="sd">    includedata=False</span>
<span class="sd">        only read the MS &quot;framework&quot; from MS, not the actual dataset</span>

<span class="sd">    dataset:    a dataset container (list or dictionary) for the readout data</span>
<span class="sd">                if it&#39;s provieded, not return from the function.</span>
<span class="sd">                if it&#39;s not provide, the readout data will be return as a dictionary. </span>
<span class="sd">                 </span>
<span class="sd">    keyrule:   &#39;number&#39;:      data_0, data_1, data_3</span>
<span class="sd">               &#39;basename&#39;:    basename1, basename2, basename3</span>
<span class="sd">               &#39;abspath&#39;:     absolute name</span>
<span class="sd">               </span>
<span class="sd">    note: we on purpose preserve the data shape to ensure write_ms will work properly</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">vis_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;relpath&#39;</span><span class="p">:</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">vis</span><span class="p">),</span>
              <span class="s1">&#39;abspath&#39;</span><span class="p">:</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">vis</span><span class="p">),</span>
              <span class="s1">&#39;basename&#39;</span><span class="p">:</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vis</span><span class="p">),</span>
              <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;uv&#39;</span><span class="p">}</span>
    
    <span class="k">if</span> <span class="n">usedouble</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">rtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
        <span class="n">ctype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">complex64</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span>
        <span class="n">ctype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span>

    <span class="c1"># set order=&#39;F&#39; for the quick access of u/v/w seperately</span>
    <span class="c1"># assuming xx/yy, we decide to save data as stokes=I to reduce the data size by x2</span>
    <span class="c1"># then the data/weight in numpy as nrecord x nchan / nrecord</span>

    <span class="n">textout</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">READing: &#39;</span><span class="o">+</span><span class="n">vis</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">textout</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">90</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">table</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>

    <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;uvw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;UVW&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">rtype</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
    <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;vis&#39;</span>
    <span class="c1"># spectrum_weight is not considered here</span>
    <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;WEIGHT&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">rtype</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">includedata</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;DATA&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">ctype</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>

    <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="k">if</span> <span class="n">flagdata</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">t</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">polaverage</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>

        <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">vis_dict</span><span class="p">:</span>
            <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;weight&#39;</span> <span class="ow">in</span> <span class="n">vis_dict</span><span class="p">:</span>
            <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;flag&#39;</span> <span class="ow">in</span> <span class="n">vis_dict</span><span class="p">:</span>
            <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># flag all data with zero weight</span>
    <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">][</span><span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># set weight=0 record with weight=1 for speeding log(wt)</span>
    <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">][</span><span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1">#   use the &quot;last&quot; and &quot;only&quot; spw in the SPECTRAL_WINDOW table</span>
    <span class="c1">#   We don&#39;t handle mutipl-spw MS here.</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">table</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="o">+</span><span class="s1">&#39;/SPECTRAL_WINDOW&#39;</span><span class="p">)</span>
    <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;chanfreq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;CHAN_FREQ&#39;</span><span class="p">)[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Hz</span>
    <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;chanwidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;CHAN_WIDTH&#39;</span><span class="p">)[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Hz</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1">#   use the &quot;last&quot; and &quot;only&quot; field phase center in the FIELD table</span>

    <span class="n">mymsmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">mymsmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
    <span class="n">phasecenter</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">phasecenter</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">telescope</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">observatorynames</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mymsmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    
    <span class="n">phasecenter</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">phasecenter</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> 
                           <span class="n">phasecenter</span><span class="p">[</span><span class="s1">&#39;m1&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;rad&quot;</span><span class="p">)</span>
    <span class="c1"># phasecenter.isscalar</span>
    <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;phasecenter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phasecenter</span>
    <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;telescope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">telescope</span>

    <span class="c1">#   only for unflagged data we calculate the below values</span>
    <span class="c1">#   we precacluate the value to avoid redundant calcualtion during likelihood calculate</span>
    <span class="c1">#   use ne.evaluate(sum(**)) could lead to wrong results due to the weight dtype=float32</span>
    <span class="n">uvflag</span> <span class="o">=</span><span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span>
    <span class="n">uvweight</span> <span class="o">=</span> <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>
    <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;ndata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">uvflag</span><span class="p">)</span>
    <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;sumwt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">uvflag</span><span class="o">*</span><span class="n">uvweight</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
    <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;sumlogwt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="o">~</span><span class="n">uvflag</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">uvweight</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">includedata</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">uvdata</span> <span class="o">=</span> <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;chanchi2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">(</span><span class="n">uvdata</span><span class="o">.</span><span class="n">real</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">uvdata</span><span class="o">.</span><span class="n">imag</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">~</span><span class="n">uvflag</span><span class="o">*</span><span class="n">uvweight</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nb">vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;uvw&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="s1">&#39;flag&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">saveflag</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;flag&#39;</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vis_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">human_unit</span><span class="p">(</span><span class="n">get_obj_size</span><span class="p">(</span><span class="n">vis_dict</span><span class="p">[</span><span class="n">var</span><span class="p">])</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">byte</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">human_to_string</span><span class="p">(</span>
            <span class="n">size</span><span class="p">,</span> <span class="n">format_string</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0.value:3.0f}</span><span class="s1"> {0.unit:shortname}&#39;</span><span class="p">)</span>
        <span class="n">textout</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:15}</span><span class="s1"> </span><span class="si">{:15}</span><span class="s1"> </span><span class="si">{:20}</span><span class="s1"> </span><span class="si">{:20}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">var</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vis_dict</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">vis_dict</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
            <span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;weight&#39;</span><span class="p">:</span>
            <span class="n">pickweight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
                <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">pickweight</span> <span class="o">=</span> <span class="n">pickweight</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)]</span>
            <span class="n">pt_select</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
            <span class="n">pt_level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">pickweight</span><span class="p">,</span> <span class="n">pt_select</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pt_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pt_select</span><span class="p">)):</span>
                <span class="n">textout</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{:15}</span><span class="s1"> </span><span class="si">{:15}</span><span class="s1"> </span><span class="si">{:&lt;20.0%}</span><span class="s1"> </span><span class="si">{:&lt;20f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;ptile:&#39;</span><span class="p">,</span> <span class="n">pt_select</span><span class="p">[</span><span class="n">pt_ind</span><span class="p">]</span><span class="o">*</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">pt_level</span><span class="p">[</span><span class="n">pt_ind</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">textout</span><span class="p">)</span>

    <span class="nb">vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chanfreq&#39;</span><span class="p">,</span> <span class="s1">&#39;chanwidth&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vis_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">textout</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:15}</span><span class="s1"> </span><span class="si">{:10}</span><span class="s1"> </span><span class="si">{:10.4f}</span><span class="s1"> </span><span class="si">{:10.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">tag</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">vis_dict</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
            <span class="n">human_unit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vis_dict</span><span class="p">[</span><span class="n">tag</span><span class="p">])),</span>
            <span class="n">human_unit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vis_dict</span><span class="p">[</span><span class="n">tag</span><span class="p">])))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">textout</span><span class="p">)</span>

    <span class="nb">vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chanchi2&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vis_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">textout</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:15}</span><span class="s1"> </span><span class="si">{:10}</span><span class="s1"> </span><span class="si">{:10.4f}</span><span class="s1"> </span><span class="si">{:10.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">tag</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">vis_dict</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vis_dict</span><span class="p">[</span><span class="n">tag</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vis_dict</span><span class="p">[</span><span class="n">tag</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">textout</span><span class="p">)</span>



    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ndata&#39;</span><span class="p">,</span><span class="s1">&#39;sumwt&#39;</span><span class="p">,</span><span class="s1">&#39;sumlogwt&#39;</span><span class="p">,</span><span class="s1">&#39;telescope&#39;</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:15}</span><span class="s1"> </span><span class="si">{:10}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">vis_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:15}</span><span class="s1"> </span><span class="si">{:10}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;phasecenter&#39;</span><span class="p">,</span> <span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;phasecenter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;hmsdms&#39;</span><span class="p">)))</span>
    
    <span class="n">count_flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">])</span>
    <span class="n">count_record</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">vis_dict</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">])</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;flagging fraction: </span><span class="si">{0:.0%}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">count_flag</span><span class="o">*</span><span class="mf">1.</span><span class="o">/</span><span class="n">count_record</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">90</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">vis_dict</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span>  <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="s1">&#39;data_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">idx</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">key</span><span class="o">=</span><span class="s1">&#39;data_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="k">if</span>  <span class="n">keyrule</span> <span class="ow">in</span> <span class="n">vis_dict</span><span class="p">:</span>
                <span class="n">key</span><span class="o">=</span><span class="n">vis_dict</span><span class="p">[</span><span class="n">keyrule</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
            <span class="k">if</span>  <span class="n">key</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;you are overwriting in the dataset: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="n">dataset</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">vis_dict</span>
            
        <span class="k">if</span>  <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vis_dict</span><span class="p">)</span>        
        
        <span class="k">return</span></div>


<div class="viewcode-block" id="write_ms"><a class="viewcode-back" href="../../../_autosummary/ism3d.uvhelper.ms.write_ms.html#ism3d.uvhelper.ms.write_ms">[docs]</a><span class="k">def</span> <span class="nf">write_ms</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
             <span class="n">datacolumn</span><span class="o">=</span><span class="s1">&#39;corrected&#39;</span><span class="p">,</span> <span class="n">inputvis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    attach new visibility data/model values into an MS</span>

<span class="sd">    if the specified datacolumn doesn&#39;t exist, it will be created on-the-fly.</span>

<span class="sd">    note:</span>
<span class="sd">        the input data shape is nrecord x nchan x ncorr following the rule in casacore.table.getcol(),</span>
<span class="sd">        which is reversed from casa6.casatools.table.getcol() (ncorr x nchan x nrecord)</span>
<span class="sd">        alternatively, ncrecord x nchan (stokes-I) is also fine and will be broadcasted to all correlations </span>
<span class="sd">        (assumed to be RR, LL, XX, or YY) </span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">inputvis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">inputvis</span> <span class="o">==</span> <span class="n">vis</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;vis and inputvis must be different!&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf &quot;</span><span class="o">+</span><span class="n">vis</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;cp -rf &#39;</span><span class="o">+</span><span class="n">inputvis</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">vis</span><span class="p">)</span>

    <span class="n">addcorr</span> <span class="o">=</span> <span class="n">addmodel</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">datacolumn</span> <span class="o">==</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span>
        <span class="n">colname</span> <span class="o">=</span> <span class="s1">&#39;DATA&#39;</span>
    <span class="k">if</span> <span class="n">datacolumn</span> <span class="o">==</span> <span class="s1">&#39;corrected&#39;</span><span class="p">:</span>
        <span class="n">colname</span> <span class="o">=</span> <span class="s1">&#39;CORRECTED_DATA&#39;</span>
        <span class="n">addcorr</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">datacolumn</span> <span class="o">==</span> <span class="s1">&#39;model&#39;</span><span class="p">:</span>
        <span class="n">colname</span> <span class="o">=</span> <span class="s1">&#39;MODEL_DATA&#39;</span>
        <span class="n">addmodel</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">tb</span> <span class="o">=</span> <span class="n">table</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">datacolumn</span> <span class="o">==</span> <span class="s1">&#39;corrected&#39;</span> <span class="ow">or</span> <span class="n">datacolumn</span> <span class="o">==</span> <span class="s1">&#39;model&#39;</span><span class="p">:</span>
        <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">colnames</span><span class="p">()</span>
        <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">colnames</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">colname</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">calibrater</span><span class="p">()</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">addcorr</span><span class="o">=</span><span class="n">addcorr</span><span class="p">,</span> <span class="n">addmodel</span><span class="o">=</span><span class="n">addmodel</span><span class="p">)</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">nomodify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">colshape</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcolshapestring</span><span class="p">(</span><span class="n">colname</span><span class="p">)</span>
    <span class="n">colshape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">colshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">+</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colshape</span><span class="p">),)</span>
    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">colshape</span><span class="p">):</span>
        <span class="n">value_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">value_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">tb</span><span class="o">.</span><span class="n">putcol</span><span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">value_in</span><span class="p">,</span> <span class="n">colshape</span><span class="p">))</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="rmPointing"><a class="viewcode-back" href="../../../_autosummary/ism3d.uvhelper.ms.rmPointing.html#ism3d.uvhelper.ms.rmPointing">[docs]</a><span class="k">def</span> <span class="nf">rmPointing</span><span class="p">(</span><span class="n">outvis</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Empty the POINTING table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span>  <span class="n">verbose</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Before rmPointing()&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;du -hs &quot;</span><span class="o">+</span><span class="n">outvis</span><span class="p">)</span>
    
    <span class="n">ctb</span><span class="o">=</span><span class="n">ctools</span><span class="o">.</span><span class="n">table</span><span class="p">()</span>
    <span class="n">ctb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outvis</span><span class="o">+</span><span class="s1">&#39;/POINTING&#39;</span><span class="p">,</span><span class="n">nomodify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ctb</span><span class="o">.</span><span class="n">nrows</span><span class="p">())</span>
    <span class="n">ctb</span><span class="o">.</span><span class="n">removerows</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ctb</span><span class="o">.</span><span class="n">nrows</span><span class="p">())))</span>
    <span class="n">ctb</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    
    <span class="c1"># rmtables(outvis+&#39;/POINTING&#39;) # doesn&#39;t work</span>
    
    <span class="k">if</span>  <span class="n">verbose</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;After rmPointing()&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;du -hs &quot;</span><span class="o">+</span><span class="n">outvis</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="rmColumns"><a class="viewcode-back" href="../../../_autosummary/ism3d.uvhelper.ms.rmColumns.html#ism3d.uvhelper.ms.rmColumns">[docs]</a><span class="k">def</span> <span class="nf">rmColumns</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span><span class="n">column</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    remove columns from MS (only handle one column currently)</span>
<span class="sd">    By default, the function will check the available column names without removing any column.</span>
<span class="sd">    e.g. column=&#39;WEIGHT_SPECTRUM&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">ctb</span><span class="o">=</span><span class="n">ctools</span><span class="o">.</span><span class="n">table</span><span class="p">()</span>
    <span class="n">ctb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span><span class="n">nomodify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span>  <span class="p">(</span><span class="n">column</span><span class="o">!=</span><span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">column</span> <span class="ow">in</span> <span class="n">ctb</span><span class="o">.</span><span class="n">colnames</span><span class="p">())</span> <span class="p">):</span>
        <span class="n">ctb</span><span class="o">.</span><span class="n">removecols</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
    <span class="c1">#ctb.close()</span>
    <span class="n">ctb</span><span class="o">.</span><span class="n">done</span><span class="p">()</span></div>
    


<div class="viewcode-block" id="checkchflag"><a class="viewcode-back" href="../../../_autosummary/ism3d.uvhelper.ms.checkchflag.html#ism3d.uvhelper.ms.checkchflag">[docs]</a><span class="k">def</span> <span class="nf">checkchflag</span><span class="p">(</span><span class="n">vis</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    check flag consistancy across channels</span>
<span class="sd">    it&#39;s able to handle ms with multiple spw/pol.</span>

<span class="sd">    note: miriad/invert slop=1,zero could include</span>
<span class="sd">          partionally flagged records into imaging</span>
<span class="sd">          We can run xutils.unchflag() and zero-out such data</span>
<span class="sd">          to implement a similar treatment:</span>
<span class="sd">          http://www.atnf.csiro.au/computing/software/miriad/userguide/node145.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;run checkchflag on &quot;</span><span class="o">+</span><span class="n">vis</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        
    <span class="n">ctb</span><span class="o">=</span><span class="n">ctools</span><span class="o">.</span><span class="n">table</span><span class="p">()</span>
    <span class="n">ctb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
    <span class="n">ids</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ctb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;DATA_DESC_ID&quot;</span><span class="p">))</span>

    <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;query: DATA_DESC_ID==&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>        

        <span class="n">subtb</span><span class="o">=</span><span class="n">ctb</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;DATA_DESC_ID==&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
        <span class="n">flag</span><span class="o">=</span><span class="n">subtb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">)</span>
        <span class="n">shape</span><span class="o">=</span><span class="n">flag</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;data shape:  &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>        
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

            <span class="n">flag0</span><span class="o">=</span><span class="n">flag</span><span class="p">[[</span><span class="n">i</span><span class="p">],:,:]</span> <span class="c1"># this will make a copy</span>
            <span class="n">flag0</span><span class="o">=</span><span class="n">flag0</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span>  <span class="c1"># otehrwise .view will not work</span>
                                <span class="c1"># flag0.strides</span>
            <span class="n">flag0</span><span class="o">=</span><span class="n">flag0</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span> <span class="p">[</span><span class="s1">&#39;i1&#39;</span><span class="p">]))</span>
            <span class="n">unique_vals</span><span class="p">,</span><span class="n">indicies</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">flag0</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">indicies</span><span class="p">)</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pol id: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; variety: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">counts</span><span class="p">)))</span>
            
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">counts</span><span class="p">)):</span>
                <span class="n">u</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">unique_vals</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">u</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[(), ]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">u</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">subtb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">ctb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="getfreqs"><a class="viewcode-back" href="../../../_autosummary/ism3d.uvhelper.ms.getfreqs.html#ism3d.uvhelper.ms.getfreqs">[docs]</a><span class="k">def</span> <span class="nf">getfreqs</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span><span class="n">frame</span><span class="o">=</span><span class="s1">&#39;LSRK&#39;</span><span class="p">,</span><span class="n">spwids</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">edge</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get the frequency sampling grid of one SPW in a MS, in a specified frame </span>
<span class="sd">    edge is for original grid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">ms</span><span class="o">=</span><span class="n">ctools</span><span class="o">.</span><span class="n">ms</span><span class="p">()</span>
    <span class="n">ms</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
    <span class="n">fgrid</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">cvelfreqs</span><span class="p">(</span><span class="n">spwids</span><span class="o">=</span><span class="n">spwids</span><span class="p">,</span>
                       <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;channel&#39;</span><span class="p">,</span>
                       <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nchan</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">outframe</span><span class="o">=</span><span class="n">frame</span><span class="p">)</span>
    <span class="n">ms</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span>  <span class="n">edge</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">fgrid</span><span class="o">=</span><span class="n">fgrid</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">edge</span><span class="p">):</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">edge</span><span class="p">)]</span>
        
        
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Additional Note</span>
<span class="sd">    ####</span>
<span class="sd">    # ToolBox can be used</span>
<span class="sd">    #   imager.advisechansel()</span>
<span class="sd">    #   ms.cvelfreqs()</span>
<span class="sd">    #   msmetadata.</span>
<span class="sd">    #   or something in analysisUtils</span>
<span class="sd">    ###</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    setLogfile(&#39;tets_advisechansel.log&#39;)</span>
<span class="sd">    </span>
<span class="sd">    im=ctools.imager()</span>
<span class="sd">    msname=&#39;uid___A002_Xc69057_X91a.ms&#39;</span>
<span class="sd">    #ctasks.listobs(vis=msname,field=&#39;BX610&#39;,intent=&#39;OBSERVE_TARGET#ON_SOURCE&#39;,spw=&#39;25,27,29,31&#39;)</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    # im.advisechansel(getfreqrange=True) will give you</span>
<span class="sd">    # left edge and right edge</span>
<span class="sd">    </span>
<span class="sd">    out=im.advisechansel(msname=msname,\</span>
<span class="sd">                         spwselection=&#39;25&#39;,</span>
<span class="sd">                         getfreqrange=True,freqframe=&#39;LSRK&#39;)</span>
<span class="sd">    print(out)</span>
<span class="sd">    out=im.advisechansel(msname=msname,\</span>
<span class="sd">                         spwselection=&#39;25:0&#39;,</span>
<span class="sd">                         getfreqrange=True,freqframe=&#39;LSRK&#39;)</span>
<span class="sd">    print(out)</span>
<span class="sd">    </span>
<span class="sd">    msmd=ctools.msmetadata()</span>
<span class="sd">    msmd.open(msname)</span>
<span class="sd">    </span>
<span class="sd">    meanfreq = msmd.meanfreq(25)</span>
<span class="sd">    bandwidth = msmd.bandwidths(25)</span>
<span class="sd">    chanwidth = msmd.chanwidths(25)[0]</span>
<span class="sd">    </span>
<span class="sd">    msmd.close()</span>
<span class="sd">        </span>
<span class="sd">    import numpy as np</span>
<span class="sd">    print(fgrid-np.roll(fgrid,1)) </span>
<span class="sd">    &quot;&quot;&quot;</span>    
        
    <span class="k">return</span> <span class="n">fgrid</span></div>

<div class="viewcode-block" id="getcommonfreqs"><a class="viewcode-back" href="../../../_autosummary/ism3d.uvhelper.ms.getcommonfreqs.html#ism3d.uvhelper.ms.getcommonfreqs">[docs]</a><span class="k">def</span> <span class="nf">getcommonfreqs</span><span class="p">(</span><span class="n">vis_list</span><span class="p">,</span><span class="n">spw_list</span><span class="p">,</span><span class="n">edge_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">frame</span><span class="o">=</span><span class="s1">&#39;LSRK&#39;</span><span class="p">,</span><span class="n">chanbin</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    edge_list: for each vis, we exclude some edge channels for evluation as they might be flagged in pipeline</span>
<span class="sd">    chanbin: the channel width will be chanbin*max(chanwidth among vis_list)</span>
<span class="sd">    output freqgrid will be covered by all vis_list</span>
<span class="sd">    fgrid:     freqeuncy grid</span>
<span class="sd">    df:        frequency resolution</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fgrid_min</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">fgrid_max</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">fgrid_df</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">if</span>  <span class="n">edge_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">edge_list</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">vis_list</span><span class="p">)</span>    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vis_list</span><span class="p">)):</span>
        <span class="n">fgrid</span><span class="o">=</span><span class="n">getfreqs</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">vis_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">spwids</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spw_list</span><span class="p">[</span><span class="n">i</span><span class="p">])],</span><span class="n">frame</span><span class="o">=</span><span class="n">frame</span><span class="p">,</span><span class="n">edge</span><span class="o">=</span><span class="n">edge_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">df</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fgrid</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">fgrid</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">fgrid_min</span><span class="o">+=</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">fgrid</span><span class="p">)</span><span class="o">-</span><span class="n">df</span><span class="o">*</span><span class="mf">0.5</span><span class="p">]</span>
        <span class="n">fgrid_max</span><span class="o">+=</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">fgrid</span><span class="p">)</span><span class="o">+</span><span class="n">df</span><span class="o">*</span><span class="mf">0.5</span><span class="p">]</span>
        <span class="n">fgrid_df</span><span class="o">+=</span><span class="p">[</span><span class="n">df</span><span class="p">]</span>
    <span class="n">fgrid_common_min</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fgrid_min</span><span class="p">)</span>
    <span class="n">fgrid_common_max</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fgrid_max</span><span class="p">)</span>
    <span class="n">fgrid_common_df</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fgrid_df</span><span class="p">)</span>
    
    <span class="n">df</span><span class="o">=</span><span class="n">fgrid_common_df</span><span class="o">*</span><span class="n">chanbin</span>
    <span class="n">fgrid_start</span><span class="o">=</span><span class="n">fgrid_common_min</span><span class="o">+</span><span class="n">df</span><span class="o">*</span><span class="mf">0.5</span>
    <span class="n">fgrid_end</span><span class="o">=</span><span class="n">fgrid_common_max</span><span class="o">-</span><span class="n">df</span><span class="o">*</span><span class="mf">0.5</span>
    <span class="n">fgrid</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">fgrid_start</span><span class="p">,</span><span class="n">fgrid_end</span><span class="p">,</span><span class="n">df</span><span class="p">)</span>
    <span class="n">fgrid</span><span class="o">=</span><span class="n">fgrid</span><span class="p">[(</span><span class="n">fgrid</span> <span class="o">&gt;=</span> <span class="n">fgrid_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">fgrid</span> <span class="o">&lt;=</span> <span class="n">fgrid_end</span><span class="p">)]</span>        
    
    <span class="k">return</span> <span class="n">fgrid</span><span class="p">,</span><span class="n">df</span></div>

<div class="viewcode-block" id="flagbywt"><a class="viewcode-back" href="../../../_autosummary/ism3d.uvhelper.ms.flagbywt.html#ism3d.uvhelper.ms.flagbywt">[docs]</a><span class="k">def</span> <span class="nf">flagbywt</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span><span class="n">datacolumn</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="n">fitspw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    doesn&#39;t really work yet (see statwt.py)</span>
<span class="sd">    performe the following procedures:</span>
<span class="sd">        1. save current flagging</span>
<span class="sd">        2. use statwt to recalculate weight</span>
<span class="sd">        3. flag weightoutlier</span>
<span class="sd">    &quot;&quot;&quot;</span>

               
    <span class="k">if</span>  <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vis</span><span class="o">+</span><span class="s1">&#39;.flagversions/flags.Original&#39;</span><span class="p">):</span>
        <span class="n">flagmanager</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;save&#39;</span><span class="p">,</span><span class="n">versionname</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">,</span><span class="n">merge</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">,</span>\
            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Before Flag by Weight&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flagmanager</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;restore&#39;</span><span class="p">,</span><span class="n">versionname</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">,</span><span class="n">merge</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>

    <span class="n">statwt</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span><span class="n">fitspw</span><span class="o">=</span><span class="n">fitspw</span><span class="p">,</span><span class="n">combine</span><span class="o">=</span><span class="s1">&#39;corr&#39;</span><span class="p">,</span><span class="n">minsamp</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">preview</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>\
           <span class="n">datacolumn</span><span class="o">=</span><span class="n">datacolumn</span><span class="p">,</span><span class="n">chanbin</span><span class="o">=</span><span class="s1">&#39;spw&#39;</span><span class="p">,</span><span class="n">statalg</span><span class="o">=</span><span class="s1">&#39;classic&#39;</span><span class="p">)</span> <span class="c1">#,timebin=&#39;300s&#39;,slidetimebin=True</span>

    <span class="n">median_wt</span><span class="o">=</span><span class="n">au</span><span class="o">.</span><span class="n">getMeanWeights</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span><span class="n">reportMedian</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span><span class="s1">&#39;median_wt before flagging:&#39;</span><span class="p">,</span><span class="n">median_wt</span><span class="p">)</span>
    
    <span class="n">flagdata</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span>
           <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;clip&#39;</span><span class="p">,</span>
           <span class="n">datacolumn</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span>
           <span class="n">clipminmax</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">median_wt</span><span class="o">*</span><span class="mf">5.0</span><span class="p">],</span><span class="n">clipoutside</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">clipzeros</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;apply&#39;</span><span class="p">)</span>    

    <span class="n">median_wt</span><span class="o">=</span><span class="n">au</span><span class="o">.</span><span class="n">getMeanWeights</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span><span class="n">reportMedian</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span><span class="s1">&#39;median_wt after flagging:&#39;</span><span class="p">,</span><span class="n">median_wt</span><span class="p">)</span>     </div>
    
<div class="viewcode-block" id="flagrow"><a class="viewcode-back" href="../../../_autosummary/ism3d.uvhelper.ms.flagrow.html#ism3d.uvhelper.ms.flagrow">[docs]</a><span class="k">def</span> <span class="nf">flagrow</span><span class="p">(</span><span class="n">vis</span><span class="p">):</span>      
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    flagged the entire row if it&#39;s partially flagged</span>
<span class="sd">    use this with cautions and you&#39;re removing potentially large amount of rows</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ctb</span><span class="o">=</span><span class="n">ctools</span><span class="o">.</span><span class="n">table</span><span class="p">()</span>
    <span class="n">ctb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span><span class="n">nomodify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">flag</span><span class="o">=</span><span class="n">ctb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">)</span>
    <span class="n">shape</span><span class="o">=</span><span class="n">flag</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># flag.shape: npol x nchanel x nrow</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">vis</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
    <span class="n">ncount</span><span class="o">=</span><span class="mi">0</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    for i in range(0,shape[0]):</span>
<span class="sd">        for j in range(0,shape[-1]):</span>
<span class="sd">            flag0=np.sum(flag[i,:,j])</span>
<span class="sd">            if  flag0!=0 and flag0!=shape[-2]:</span>
<span class="sd">                flag[i,:,j]=True</span>
<span class="sd">                ncount+=1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">flag0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">flag</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">])</span>
        <span class="k">if</span>  <span class="n">flag0</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">flag0</span><span class="o">!=</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]):</span>
            <span class="n">flag</span><span class="p">[:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>
            <span class="n">ncount</span><span class="o">+=</span><span class="mi">1</span>                
    
    <span class="nb">print</span><span class="p">(</span><span class="n">ncount</span><span class="p">)</span>
    <span class="n">ctb</span><span class="o">.</span><span class="n">putcol</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">,</span><span class="n">flag</span><span class="p">)</span>
    <span class="n">ctb</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>    </div>
    
    
<div class="viewcode-block" id="flagchan"><a class="viewcode-back" href="../../../_autosummary/ism3d.uvhelper.ms.flagchan.html#ism3d.uvhelper.ms.flagchan">[docs]</a><span class="k">def</span> <span class="nf">flagchan</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    flagged the channel if the data from contributing rows are partially flagged</span>
<span class="sd">    this is &lt;unchflag&gt; in the CASA 5 xutils</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="k">pass</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Rui Xue

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>